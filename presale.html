<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WPO — Presale</title>
  <meta name="description" content="WPO Presale — pay with wallet + instant email confirmation + receipt." />

  <style>
    :root{--bg:#050812;--card:#0b1224;--txt:#e7edf6;--muted:#9aa4b2;--br:#1c2946;--gold:#f5cc66;--acc:#7c3aed;--acc2:#2563eb}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:radial-gradient(1200px 700px at 25% 0%, #0b1530 0%, var(--bg) 55%);color:var(--txt)}
    .wrap{max-width:1120px;margin:26px auto;padding:16px}
    .card{background:rgba(11,18,36,.92);border:1px solid var(--br);border-radius:18px;padding:16px;box-shadow:0 12px 34px rgba(0,0,0,.28)}
    .top{display:flex;gap:14px;align-items:center;flex-wrap:wrap}
    .brand{display:flex;gap:12px;align-items:center}
    .brand img{width:44px;height:44px;border-radius:12px;border:1px solid var(--br);background:#071025}
    h1{margin:0;font-size:24px}
    h2{margin:0 0 10px 0;font-size:16px;color:#d7e2f3}
    .muted{color:var(--muted);font-size:13px;line-height:1.6}
    .badge{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--br);background:rgba(255,255,255,.02);padding:8px 12px;border-radius:999px;font-size:12px;color:#cfe0ff}
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:14px;margin-top:14px}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .img{width:100%;border-radius:16px;border:1px solid var(--br);background:#071025}
    .hr{height:1px;background:var(--br);margin:14px 0}
    label{display:block;margin:10px 0 6px;color:#cfe0ff;font-size:13px}
    input,textarea,button{width:100%;box-sizing:border-box;padding:12px;border-radius:12px;border:1px solid var(--br);background:#0a1224;color:var(--txt);outline:none}
    input:focus,textarea:focus{border-color:#2a3f72}
    button{cursor:pointer;background:#122246;border-color:#243a6b;font-weight:650}
    button:hover{filter:brightness(1.06)}
    button:disabled{opacity:.65;cursor:not-allowed}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn2{width:auto;white-space:nowrap;background:#0f1b35}
    .btnPrimary{
      width:100%;
      background: linear-gradient(135deg, var(--acc2), var(--acc));
      border-color: rgba(255,255,255,.10);
      font-weight:850;
    }
    .status{display:none;margin-top:12px;padding:12px;border-radius:12px;border:1px solid var(--br);background:rgba(255,255,255,.02);font-size:13px;line-height:1.6;word-break:break-word}
    .ok{border-color:rgba(25,195,125,.35);background:rgba(25,195,125,.10)}
    .warn{border-color:rgba(245,158,11,.35);background:rgba(245,158,11,.08)}
    .gold{color:var(--gold)}
    .small{font-size:12px}
    .box{border:1px solid var(--br);background:rgba(255,255,255,.02);border-radius:14px;padding:12px}
    .kv{display:flex;justify-content:space-between;gap:10px;margin:6px 0;font-size:13px}
    .kv b{color:#eaf0ff}
  </style>

  <!-- EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <!-- Ethers (for Pay with Wallet) -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
   <!-- Back to Home Button -->
    <div style="margin-top:10px;">
        <a href="index.html" style="
            display:inline-block;
            background:#f5c15d;
            color:#050b1f;
            padding:8px 15px;
            border-radius:6px;
            text-decoration:none;
            font-weight:600;
            transition:0.3s;
        " onmouseover="this.style.background='#ffd98a'" onmouseout="this.style.background='#f5c15d'">
            Back to Home
        </a>
    </div>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <div class="brand">
          <img src="assets/wpo-logo-200.png" alt="WPO" />
          <div>
            <h1>WPO — Presale</h1>
            <div class="muted">BNB Smart Chain (BSC) • Pay with wallet • Instant email receipt</div>
          </div>
        </div>
        <div class="badge">Token: <b id="sym"></b></div>
        <div class="badge">Presale: <b class="gold" id="presaleTxt"></b> / token</div>
        <div class="badge">Next Listing: <b class="gold" id="listingTxt"></b> / token</div>
        <div class="badge">Supply: <b>7,500,000</b></div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>Tokenomics</h2>
        <div class="muted">Allocation overview (team vesting + liquidity + community rewards).</div>
        <div class="hr"></div>
        <img class="img" src="assets/wpo_tokenomics_infographic.png" alt="WPO Tokenomics" />
        <div class="hr"></div>
        <h2>How to buy</h2>
        <ol class="muted">
          <li>Connect your wallet (BSC network).</li>
          <li>Enter BNB amount and click <b>Pay with Wallet</b>.</li>
          <li>After confirmation, submit your email to get receipt instantly.</li>
        </ol>
        <div class="status warn" style="display:block">
          Verify on BscScan: <span class="mono">https://bscscan.com/tx/&lt;TX_HASH&gt;</span>
        </div>
      </div>

      <div class="card">
        <h2>Presale wallet (receive BNB)</h2>
        <div class="muted">Receiver address (BSC only):</div>

        <div class="row" style="margin-top:10px">
          <input id="receiver" class="mono" readonly />
          <button class="btn2" id="copyBtn" type="button">Copy</button>
        </div>

        <div class="hr"></div>

        <h2>Pay with Wallet</h2>
        <div class="muted small">This will send BNB directly from your connected wallet to the receiver address.</div>

        <div class="box" style="margin-top:10px">
          <div class="kv"><span class="muted">Wallet</span><b id="walletTxt">Not connected</b></div>
          <div class="kv"><span class="muted">You receive (est.)</span><b id="recvTxt">—</b></div>
          <div class="muted small">Estimate uses public BNB/USD price for display only.</div>
        </div>

        <div class="row" style="margin-top:10px">
          <button class="btn2" id="connectBtn" type="button">Connect Wallet</button>
          <button class="btn2" id="switchBtn" type="button">Switch to BSC</button>
        </div>

        <label style="margin-top:10px">Amount (BNB)</label>
        <input id="amountPay" type="number" step="0.000001" inputmode="decimal" placeholder="e.g. 0.5" />

        <button id="payBtn" class="btnPrimary" type="button" style="margin-top:12px">Pay with Wallet (BNB)</button>
        <div id="payMsg" class="status"></div>

        <div class="hr"></div>

        <h2>Confirm your purchase (Email receipt)</h2>
        <div class="muted small">After payment, your wallet + amount + tx hash will auto-fill. Enter your email and submit.</div>

        <form id="buyForm" style="margin-top:10px">
          <label>Email (for receipt)</label>
          <input name="buyer_email" type="email" required placeholder="name@example.com" />

          <label>Your wallet address (sender)</label>
          <input name="buyer_wallet" id="buyerWallet" class="mono" required placeholder="0x..." />

          <label>Amount sent (BNB)</label>
          <input name="amount_bnb" id="amountSent" type="number" step="0.000001" inputmode="decimal" required placeholder="e.g. 0.5" />

          <label>Tx Hash</label>
          <input name="tx_hash" id="txHash" class="mono" required placeholder="0x..." />

          <label>Note (optional)</label>
          <textarea name="note" rows="3" placeholder="Any extra details..."></textarea>

          <!-- honeypot anti-bot -->
          <input name="website" style="display:none" tabindex="-1" autocomplete="off" />

          <button id="submitBtn" type="submit" style="margin-top:12px">Submit & Get Receipt</button>
          <div id="msg" class="status"></div>
        </form>
      </div>
    </div>
  </div>

  <script>
    // =========================
    // CONFIG
    // =========================
    const TOKEN_SYMBOL = "WPO";
    const PRESALE_PRICE_USD = 0.25;  // ✅ updated
    const LISTING_PRICE_USD = 0.30;  // ✅ updated
    const RECEIVER_BNB_ADDRESS = "0xbfa20bec0dac600c197312f661a625d3cc3d048b";

    const EMAILJS_PUBLIC_KEY = "pvMOyv5qJOCXRscyF";
    const EMAILJS_SERVICE_ID = "service_u79fbik";
    const TEMPLATE_ADMIN_ID  = "template_0zsanea";
    const TEMPLATE_USER_ID   = "template_w3l1mlr";

    // UI min buy (optional)
    const MIN_BUY_USD = 5;

    // BSC chain
    const BSC = {
      chainId: "0x38",
      chainName: "BNB Smart Chain",
      nativeCurrency: { name:"BNB", symbol:"BNB", decimals:18 },
      rpcUrls: ["https://bsc-dataseed.binance.org/"],
      blockExplorerUrls: ["https://bscscan.com/"]
    };

    // =========================
    // INIT
    // =========================
    emailjs.init({ publicKey: EMAILJS_PUBLIC_KEY });

    document.getElementById("sym").textContent = TOKEN_SYMBOL;
    document.getElementById("presaleTxt").textContent = `$${PRESALE_PRICE_USD.toFixed(2)}`;
    document.getElementById("listingTxt").textContent = `$${LISTING_PRICE_USD.toFixed(2)}`;
    document.getElementById("receiver").value = RECEIVER_BNB_ADDRESS;

    document.getElementById("copyBtn").addEventListener("click", async () => {
      try{ await navigator.clipboard.writeText(RECEIVER_BNB_ADDRESS); alert("Copied ✅"); }
      catch(e){ alert("Copy failed. Please copy manually."); }
    });

    // =========================
    // Helpers
    // =========================
    const msg = document.getElementById("msg");
    const submitBtn = document.getElementById("submitBtn");
    const payBtn = document.getElementById("payBtn");
    const connectBtn = document.getElementById("connectBtn");
    const switchBtn = document.getElementById("switchBtn");
    const payMsg = document.getElementById("payMsg");
    const amountPay = document.getElementById("amountPay");

    const show = (el, text, type) => {
      el.style.display = "block";
      el.className = "status " + (type === "ok" ? "ok" : "warn");
      el.textContent = text;
    };

    const setLoading = (btn, isLoading, loadingText, normalText) => {
      btn.disabled = isLoading;
      btn.textContent = isLoading ? loadingText : normalText;
    };

    const shortAddr = (a) => a ? (a.slice(0,6) + "…" + a.slice(-4)) : "Not connected";

    const makeOrderId = () => {
      const ts = Date.now().toString(36).toUpperCase();
      const rnd = Math.random().toString(36).slice(2, 8).toUpperCase();
      return `WPO-${ts}-${rnd}`;
    };

    const makeLogoUrl = () => new URL("assets/wpo-logo-200.png", window.location.href).href;

    // =========================
    // Wallet / Payment
    // =========================
    let provider=null, signer=null, user=null;
    let bnbUsd=null;

    async function ensureBSC(){
      if(!window.ethereum) throw new Error("No wallet found. Please install MetaMask.");
      const chainId = await window.ethereum.request({ method:"eth_chainId" });
      if(chainId === BSC.chainId) return;
      try{
        await window.ethereum.request({ method:"wallet_switchEthereumChain", params:[{ chainId: BSC.chainId }] });
      }catch(e){
        if(e.code === 4902){
          await window.ethereum.request({ method:"wallet_addEthereumChain", params:[BSC] });
        } else throw e;
      }
    }

    async function connectWallet(){
      await ensureBSC();
      provider = new ethers.providers.Web3Provider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
      signer = provider.getSigner();
      user = await signer.getAddress();

      document.getElementById("walletTxt").textContent = shortAddr(user);
      document.getElementById("buyerWallet").value = user;

      show(payMsg, "Wallet connected ✅", "ok");

      window.ethereum.on?.("accountsChanged", ()=>location.reload());
      window.ethereum.on?.("chainChanged", ()=>location.reload());
    }

    connectBtn.addEventListener("click", async ()=>{
      try{ await connectWallet(); }
      catch(e){ show(payMsg, e.message || "Failed to connect.", "warn"); }
    });

    switchBtn.addEventListener("click", async ()=>{
      try{
        await ensureBSC();
        show(payMsg, "Switched to BSC ✅", "ok");
      }catch(e){
        show(payMsg, e.message || "Failed to switch network.", "warn");
      }
    });

    async function fetchBnbUsd(){
      try{
        const url = "https://api.coingecko.com/api/v3/simple/price?ids=binancecoin&vs_currencies=usd&v=" + Date.now();
        const r = await fetch(url, { cache:"no-store" });
        const j = await r.json();
        const p = j?.binancecoin?.usd;
        if(typeof p === "number" && p > 0){
          bnbUsd = p;
          recalcReceive();
        }
      }catch(e){ /* ignore */ }
    }

    function recalcReceive(){
      const v = Number(amountPay.value || 0);
      if(!v || !bnbUsd){
        document.getElementById("recvTxt").textContent = "—";
        return;
      }
      const usd = v * bnbUsd;
      const tokens = usd / PRESALE_PRICE_USD;
      document.getElementById("recvTxt").textContent =
        `${tokens.toLocaleString(undefined,{maximumFractionDigits:4})} ${TOKEN_SYMBOL} (≈ $${usd.toLocaleString(undefined,{maximumFractionDigits:2})})`;
    }

    amountPay.addEventListener("input", recalcReceive);
    fetchBnbUsd();
    setInterval(fetchBnbUsd, 60_000);

    payBtn.addEventListener("click", async ()=>{
      try{
        if(!signer) await connectWallet();

        const amount = Number((amountPay.value || "").trim());
        if(!amount || amount <= 0) return show(payMsg, "Enter a valid BNB amount.", "warn");

        // optional min buy check (approx)
        if(bnbUsd){
          const usd = amount * bnbUsd;
          if(usd < MIN_BUY_USD){
            return show(payMsg, `Minimum buy is about $${MIN_BUY_USD}. Increase amount.`, "warn");
          }
        }

        setLoading(payBtn, true, "Sending…", "Pay with Wallet (BNB)");
        show(payMsg, "Confirm transaction in your wallet…", "warn");

        const tx = await signer.sendTransaction({
          to: RECEIVER_BNB_ADDRESS,
          value: ethers.utils.parseEther(String(amount))
        });

        show(payMsg, "Pending… " + tx.hash, "warn");
        const receipt = await tx.wait();

        if(!receipt || receipt.status !== 1){
          setLoading(payBtn, false, "Sending…", "Pay with Wallet (BNB)");
          return show(payMsg, "Transaction failed on-chain.", "warn");
        }

        // Auto-fill form
        document.getElementById("amountSent").value = amount;
        document.getElementById("txHash").value = tx.hash;
        document.getElementById("buyerWallet").value = user;

        setLoading(payBtn, false, "Sending…", "Pay with Wallet (BNB)");
        show(payMsg, "Payment confirmed ✅ Now enter your email and submit to get receipt.", "ok");
      }catch(e){
        setLoading(payBtn, false, "Sending…", "Pay with Wallet (BNB)");
        show(payMsg, e?.data?.message || e.message || "Payment failed.", "warn");
      }
    });

    // Auto-connect if already authorized
    if(window.ethereum){
      window.ethereum.request({ method:"eth_accounts" })
        .then(acc => { if(acc && acc.length) connectWallet(); })
        .catch(()=>{});
    }

    // =========================
    // Email receipt form
    // =========================
    document.getElementById("buyForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      // honeypot
      const hp = e.target.querySelector('input[name="website"]')?.value;
      if(hp) return;

      setLoading(submitBtn, true, "Sending...", "Submit & Get Receipt");
      show(msg, "Sending your receipt...", "warn");

      const fd = new FormData(e.target);
      const data = Object.fromEntries(fd.entries());

      if(!data.buyer_wallet || data.buyer_wallet.length < 10 || !data.tx_hash || data.tx_hash.length < 10){
        setLoading(submitBtn, false, "Sending...", "Submit & Get Receipt");
        show(msg, "Invalid wallet address or Tx Hash.", "warn");
        return;
      }

      data.order_id = makeOrderId();
      data.logo_url = makeLogoUrl();
      data.token_symbol = TOKEN_SYMBOL;
      data.presale_price_usd = PRESALE_PRICE_USD.toFixed(2);
      data.listing_price_usd = LISTING_PRICE_USD.toFixed(2);
      data.receiver_address = RECEIVER_BNB_ADDRESS;
      data.network = "BSC";
      data.bscscan_link = `https://bscscan.com/tx/${data.tx_hash}`;

      try{
        await emailjs.send(EMAILJS_SERVICE_ID, TEMPLATE_ADMIN_ID, data);
        await emailjs.send(EMAILJS_SERVICE_ID, TEMPLATE_USER_ID, data);
        setLoading(submitBtn, false, "Sending...", "Submit & Get Receipt");
        show(msg, "Submitted successfully! Receipt sent to your email ✅", "ok");
        e.target.reset();

        // keep wallet if connected
        if(user) document.getElementById("buyerWallet").value = user;

      }catch(err){
        setLoading(submitBtn, false, "Sending...", "Submit & Get Receipt");
        show(msg, "Failed to send. Please try again.", "warn");
      }
    });
  </script>
</body>
</html>
